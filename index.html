<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Q2les Aangifte - Evi de Vries</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --police: #1a2a6c; --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; }
        body { background-color: #0a0e14; color: #d1d1d1; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .main-wrapper { display: flex; gap: 20px; max-width: 1500px; margin: auto; height: calc(100vh - 40px); }
        
        #chat-section { flex: 1; min-width: 380px; background: #1c222d; border: 2px solid var(--police); display: flex; flex-direction: column; border-radius: 8px; overflow: hidden; }
        #messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f4f7f6; }
        .status-header { background: var(--police); padding: 10px; color: white; display: flex; justify-content: space-between; font-size: 0.8em; }
        #stress-meter { height: 5px; background: var(--success); width: 100%; transition: 1s; }

        #aangifte-section { flex: 1.5; min-width: 500px; background: #ffffff; border: 2px solid #bdc3c7; display: flex; flex-direction: column; padding: 20px; border-radius: 8px; color: #333; overflow-y: auto; }
        
        .bubble { max-width: 85%; padding: 12px; border-radius: 15px; font-size: 0.9em; line-height: 1.4; }
        .bot { align-self: flex-start; background: #e8e8e8; color: #2c3e50; border-bottom-left-radius: 2px; }
        .user-msg { align-self: flex-end; background: var(--police); color: white; border-bottom-right-radius: 2px; }
        
        textarea { width: 100%; min-height: 180px; border: 2px solid var(--police); padding: 10px; border-radius: 4px; resize: none; font-size: 1em; margin-bottom: 10px; }
        
        #check-section { margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px; border-left: 5px solid var(--police); }
        .check-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 0.85em; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .dot-green { background: var(--success); }
        .dot-red { background: var(--danger); }

        .feed-item { background: #f9f9f9; border: 1px solid #ddd; padding: 12px; margin-top: 15px; border-radius: 8px; position: relative; }
        button { background: var(--police); color: white; border: none; padding: 10px; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-pv { background: var(--success); width: 100%; margin: 10px 0; font-size: 1.1em; }
        .btn-download { background: #e67e22; width: 100%; margin-top: 10px; }
        .btn-clear { background: #95a5a6; font-size: 0.7em; margin-top: 15px; width: 100%; }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div id="chat-section">
        <div class="status-header">
            <span>VERHOOR: EVI DE VRIES</span>
            <span id="stress-txt">STATUS: AFWACHTEND</span>
        </div>
        <div id="stress-meter"></div>
        <div id="messages">
            <div class="bubble bot"><b>Evi:</b> Goedemorgen. Ik kom aangifte doen... mijn witte Gazelle is weg.</div>
        </div>
        <div style="padding:15px; background:white; display:flex; gap:10px; border-top:1px solid #eee;">
            <input type="text" id="botInput" style="flex:1; padding:10px; border:1px solid #ccc;" placeholder="Stel een vraag aan Evi..." onkeypress="if(event.key==='Enter') chatWithBot()">
            <button onclick="chatWithBot()">VRAAG</button>
        </div>
    </div>

    <div id="aangifte-section">
        <div id="pdf-content">
            <h2 style="color:var(--police); margin:0 0 10px 0;">Proces-Verbaal van Aangifte</h2>
            <p style="font-size: 0.8em; color: #666; margin-bottom: 10px;">Slachtoffer: E. de Vries</p>
            
            <textarea id="pvInput" placeholder="Stel hier de officiÃ«le aangifte op in de ik-vorm..." oninput="checkPV()"></textarea>
            
            <div id="check-section" class="no-print">
                <b style="font-size: 0.9em; color: var(--police);">PV Aangifte Check:</b>
                <div class="check-item"><div id="c1" class="status-dot"></div><span>Geen toestemming</span></div>
                <div class="check-item"><div id="c2" class="status-dot"></div><span>Vernieling</span></div>
                <div class="check-item"><div id="c3" class="status-dot"></div><span>Omschrijving</span></div>
                <div class="check-item"><div id="c4" class="status-dot"></div><span>Ik-vorm</span></div>
                <div class="check-item"><div id="c5" class="status-dot"></div><span>Gouden W's</span></div>
                <div class="check-item"><div id="c6" class="status-dot"></div><span>Redenen van wetenschap</span></div>
            </div>

            <div id="feed-container"></div>
        </div>

        <button class="btn-pv no-print" onclick="submitToFirebase()">OPSLAAN IN ARCHIEF</button>
        <button class="btn-download no-print" onclick="downloadPDF()">DOWNLOAD PDF</button>
        <button class="btn-clear no-print" onclick="clearDatabase()">WIS ARCHIEF</button>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyC-Of0AUOd-kVo2RKxYc-68Gr-RO4HdRk0", authDomain: "q2aangifteles2.firebaseapp.com", databaseURL: "https://q2aangifteles2-default-rtdb.europe-west1.firebasedatabase.app", projectId: "q2aangifteles2" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let stress = 15;

    const responses = {
        hallo: ["Ik kom aangifte doen... mijn witte Gazelle is weg. Het slot ligt kapot op de grond.", "Goedemorgen. Er is een fiets gestolen bij mijn huis.", "Hallo. Ik wil graag een diefstal melden."],
        naam: ["Mijn volledige naam is Evi de Vries.", "Ik ben Evi de Vries.", "Gewoon Evi de Vries."],
        datum: ["Ik ben geboren op 4 november 2002.", "Dat is 4 november 2002.", "Mijn geboortedatum is 04-11-2002."],
        adres: ["Ik woon aan het Vredenburg 24-B in Utrecht.", "Dat is aan het Vredenburg, nummer 24-B.", "Mijn adres is Vredenburg 24-B."],
        slot: ["Mijn ringslot ligt nu kapot op de straat.", "Ze hebben de ABUS-ketting gewoon doorgeknipt.", "Hij stond op slot met een ringslot en een dikke ketting, maar die zijn vernield."],
        waarde: ["De fiets heeft 649 euro gekost.", "De waarde is 649 euro.", "Ik heb de bon nog, hij was 649 euro."],
        tijd: ["Het gebeurde vannacht om 03:15 uur.", "Rond 03:15 uur schrok ik wakker van lawaai.", "Ik zag op de wekker dat het 03:15 uur was."],
        kenmerken: ["Het is een witte Gazelle Esprit.", "Hij heeft een zwart rekje voorop en een madelief-sticker op de stang.", "Het model is een Gazelle Esprit, kleur wit."],
        toestemming: ["Nee, natuurlijk heb ik geen toestemming gegeven!", "Meent u dat nou? Ik heb niemand recht gegeven om mijn fiets mee te nemen!", "Absoluut niet, het is diefstal."],
        verward: ["Dat begrijp ik niet helemaal...", "Kunt u de vraag anders stellen?", "Ik weet het even niet meer, ik ben nogal geschrokken."]
    };

    function getRandom(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function chatWithBot() {
        const input = document.getElementById('botInput');
        const v = input.value.toLowerCase();
        if(!v) return;
        
        addBubble(input.value, 'user-msg');
        input.value = '';

        setTimeout(() => {
            let r = "";
            let topic = "";

            if (v.includes("hallo") || v.includes("morgen") || v.includes("middag") || v.includes("helpen")) topic = "hallo";
            else if (v.includes("naam") || v.includes("heet")) topic = "naam";
            else if (v.includes("datum") || v.includes("geboren") || v.includes("oud")) topic = "datum";
            else if (v.includes("adres") || v.includes("woon") || v.includes("plek")) topic = "adres";
            else if (v.includes("slot") || v.includes("kapot") || v.includes("ketting") || v.includes("vast")) topic = "slot";
            else if (v.includes("waarde") || v.includes("geld") || v.includes("kost") || v.includes("prijs")) topic = "waarde";
            else if (v.includes("tijd") || v.includes("uur") || v.includes("wanneer") || v.includes("laat")) topic = "tijd";
            else if (v.includes("gazelle") || v.includes("wit") || v.includes("eruit") || v.includes("kenmerk") || v.includes("sticker")) topic = "kenmerken";
            else if (v.includes("toestemming") || v.includes("toegestaan") || v.includes("gegeven")) topic = "toestemming";

            if(topic) {
                r = getRandom(responses[topic]);
                stress += 2;
            } else {
                r = getRandom(responses.verward);
                stress += 4;
            }

            addBubble(r, 'bot');
            updateStressUI();
        }, 600);
    }

    function checkPV() {
        const t = document.getElementById('pvInput').value;
        const lowT = t.toLowerCase();
        const updateDot = (id, condition) => {
            document.getElementById(id).className = condition ? "status-dot dot-green" : "status-dot dot-red";
        };

        updateDot("c1", lowT.includes("geen toestemming") || lowT.includes("zonder mijn toestemming"));
        updateDot("c2", lowT.includes("verniel") || lowT.includes("kapot") || lowT.includes("verbroken") || lowT.includes("geforceerd"));
        updateDot("c3", lowT.includes("wit") && lowT.includes("gazelle") && lowT.includes("649"));
        updateDot("c4", t.includes("Ik ") || t.includes("ik "));
        updateDot("c5", lowT.includes("vredenburg") && lowT.includes("4 november") && lowT.includes("2002"));
        const redenRegex = /(ik|aangeefster)\s+(verklaar|zag|hoorde|bevestig|merkte)\s+dat/i;
        updateDot("c6", redenRegex.test(lowT));
    }

    function updateStressUI() {
        const meter = document.getElementById('stress-meter');
        meter.style.width = Math.max(0, (100 - stress)) + "%";
        if(stress > 70) meter.style.background = "var(--danger)";
    }

    function addBubble(text, side) {
        const div = document.createElement('div');
        div.className = `bubble ${side}`;
        div.innerHTML = side === 'bot' ? `<b>Evi:</b> ${text}` : text;
        const m = document.getElementById('messages');
        m.appendChild(div);
        m.scrollTop = m.scrollHeight;
    }

    function submitToFirebase() {
        const txt = document.getElementById('pvInput').value.trim();
        if(!txt) return;
        db.ref('posts').push({ tekst: txt, timestamp: new Date().toLocaleString() });
        document.getElementById('pvInput').value = '';
        checkPV();
        alert("Opgeslagen in archief!");
    }

    db.ref('posts').on('value', (snap) => {
        const container = document.getElementById('feed-container');
        container.innerHTML = "<h3 class='no-print' style='margin-top:20px;'>ARCHIEF</h3>";
        const data = snap.val();
        if(data) {
            Object.keys(data).reverse().forEach(id => {
                const item = data[id];
                const div = document.createElement('div');
                div.className = 'feed-item';
                div.innerHTML = `<div style="font-size:0.75em; color:#888;">${item.timestamp}</div><div style="font-size:0.95em;">${item.tekst}</div>`;
                container.appendChild(div);
            });
        }
    });

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        const opt = {
            margin: 10,
            filename: 'PV_Aangifte_Evi.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    function clearDatabase() { 
        if(confirm("Weet je zeker dat je het volledige archief wilt wissen?")) {
            db.ref('posts').remove(); 
        }
    }
</script>
</body>
</html>
